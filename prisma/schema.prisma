generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id              String           @id @default(cuid())
  name            String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  users           User[]
  vehicles        Vehicle[]
  drivers         Driver[]
  contractedTours ContractedTour[]
  calendarEvents  CalendarEvent[]

  @@map("organization")
}

model User {
  id                        String        @id
  name                      String
  email                     String        @unique
  emailVerified             Boolean       @default(false)
  image                     String?
  createdAt                 DateTime      @default(now())
  updatedAt                 DateTime      @default(now()) @updatedAt
  emailNotificationsEnabled Boolean       @default(true)
  notificationDaysBefore    Int           @default(30)
  role                      UserRole      @default(DISPONENT)
  organizationId            String?
  organization              Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  accounts                  Account[]
  sessions                  Session[]

  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

model Vehicle {
  id                     String              @id @default(cuid())
  name                   String
  registrationNumber     String
  vehicleType            VehicleType
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  organizationId         String
  ppAparatExpiryDate     DateTime?
  registrationExpiryDate DateTime?
  sixMonthInspectionDate DateTime?
  fireExtinguishers      FireExtinguisher[]
  maintenanceRecords     MaintenanceRecord[]
  organization           Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  truckTours             ContractedTour[]    @relation("TruckTours")
  trailerTours           ContractedTour[]    @relation("TrailerTours")

  @@unique([registrationNumber, organizationId])
  @@map("vehicle")
}

model MaintenanceRecord {
  id          String   @id @default(cuid())
  description String
  date        DateTime
  vehicleId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  vehicle     Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@map("maintenance_record")
}

model FireExtinguisher {
  id                 String               @id @default(cuid())
  serialNumber       String               @unique
  type               FireExtinguisherType
  manufacturerDate   DateTime
  lastInspectionDate DateTime
  nextInspectionDate DateTime
  vehicleId          String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  vehicle            Vehicle?             @relation(fields: [vehicleId], references: [id])

  @@map("fire_extinguisher")
}

model Driver {
  id                    String           @id @default(cuid())
  name                  String
  phoneNumber           String
  email                 String?
  licenseNumber         String
  licenseExpiryDate     DateTime?
  medicalExamExpiryDate DateTime?
  driverCardExpiryDate  DateTime?
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  organizationId        String
  organization          Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  notes                 DriverNote[]
  contractedTours       ContractedTour[]

  @@unique([licenseNumber, organizationId])
  @@map("driver")
}

model DriverNote {
  id        String   @id @default(cuid())
  content   String
  noteType  NoteType
  driverId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  driver    Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@map("driver_note")
}

model ContractedTour {
  id              String          @id @default(cuid())
  tourType        TourType
  loadingLocation String
  loadingDate     DateTime?
  exportCustoms   String?
  importCustoms   String?
  price           Decimal         @db.Decimal(10, 2)
  company         String
  isADR           Boolean         @default(false)
  isCompleted     Boolean         @default(false)
  isInvoiced      Boolean         @default(false)
  completedAt     DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  organizationId  String
  driverId        String?
  truckId         String?
  trailerId       String?
  organization    Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  driver          Driver?         @relation(fields: [driverId], references: [id], onDelete: SetNull)
  truck           Vehicle?        @relation("TruckTours", fields: [truckId], references: [id], onDelete: SetNull)
  trailer         Vehicle?        @relation("TrailerTours", fields: [trailerId], references: [id], onDelete: SetNull)
  unloadingStops  UnloadingStop[]

  @@map("contracted_tour")
}

model UnloadingStop {
  id            String         @id @default(cuid())
  location      String
  unloadingDate DateTime?
  tourId        String
  tour          ContractedTour @relation(fields: [tourId], references: [id], onDelete: Cascade)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@map("unloading_stop")
}

model CalendarEvent {
  id             String       @id @default(cuid())
  title          String
  description    String?
  date           DateTime
  eventType      EventType
  color          String?
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@map("calendar_event")
}

enum EventType {
  CUSTOM
  VEHICLE_EXPIRY
  DRIVER_EXPIRY
  TOUR_LOADING
  TOUR_UNLOADING
}

enum VehicleType {
  KAMION
  PRIKOLICA
}

enum FireExtinguisherType {
  PP_APARAT_6KG
  PP_APARAT_12KG
  CO2_APARAT
  PJENA_APARAT
}

enum NoteType {
  POSITIVE
  NEGATIVE
}

enum TourType {
  UVOZ
  IZVOZ
  MEDJUTURA
}

enum UserRole {
  DIREKTOR
  DISPONENT
  KNJIGOVODJA
  SERVISER
}
